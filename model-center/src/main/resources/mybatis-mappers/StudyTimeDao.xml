<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloud.model.dao.StudyTimeDao">
    <!-- 查看表是否存在 -->
    <select id="getTable" parameterType="string" resultType="int">
        SELECT COUNT
        ( * )
        FROM
        dba_tables
        WHERE
        Table_Name = #{tableName}
    </select>


    <select id="getTableCountByDbType" parameterType="map" resultType="int">
        SELECT COUNT (*)
        FROM
            ${dbTableName}
        WHERE
            ${fileName} = #{tableName}
    </select>



    <!-- 创建表 -->
    <insert id="createTable" parameterType="map" >
        CREATE TABLE  ${tableName}
        (
            "id" INT IDENTITY(1, 1) NOT NULL,
            "user_id" INT,
            "kn_id" VARCHAR(64),
            "start_time" TIMESTAMP(0),
            "end_time" TIMESTAMP(0),
            "time_count" INT,
            "create_time" TIMESTAMP(0),
            "update_time" TIMESTAMP(0),
            "view_state" SMALLINT,
            "use_state" SMALLINT,
            CONSTRAINT  "pkey" NOT CLUSTER PRIMARY KEY("id")) STORAGE(ON "MAIN", CLUSTERBTR)
        );
    </insert>


    <insert id="createPgTable" parameterType="map" >

       CREATE TABLE ${tableName} (
            "id" int4 NOT NULL GENERATED BY DEFAULT AS IDENTITY (
                INCREMENT 1
                MINVALUE  1
                START 1
                ),
              "user_id" int4,
              "kn_id" varchar(64) COLLATE "pg_catalog"."default",
              "start_time" timestamp(0),
              "end_time" timestamp(0),
              "time_count" int4,
              "create_time" timestamp(0),
              "update_time" timestamp(0),
              "view_state" int2 DEFAULT 2,
              "use_state" int2 DEFAULT 1,
              CONSTRAINT  ${primary} PRIMARY KEY ("id")
            );
    </insert>


    <!--    人大金仓 创建序列 -->
    <insert id="createSequenceKingBase" parameterType="map" >
        CREATE sequence ${squence} increment  by 1  minvalue 1 start with 1 ;
    </insert>

<!--    人大金仓数据库 创建
        void createTableKingBase(Map<String,Object> map);
        void createSequenceKingBase(Map<String,Object> map);
-->
    <insert id="createTableKingBase" parameterType="map" >
        CREATE TABLE  ${tableName}
        (
            "id" INT NOT NULL default nextval('${squence}') primary key,
            "user_id" INT,
            "kn_id" VARCHAR(64),
            "start_time" TIMESTAMP(0),
            "end_time" TIMESTAMP(0),
            "time_count" INT,
            "create_time" TIMESTAMP(0),
            "update_time" TIMESTAMP(0),
            "view_state" SMALLINT,
            "use_state" SMALLINT
        )    ;
    </insert>








    <!-- 新增学习时间数据-->
    <insert id="saveInfo" parameterType="map">
        INSERT INTO ${tableName} ( user_id, kn_id, start_time, create_time, time_count, update_time,view_state )
        VALUES
        ( #{userId}, #{knId}, #{startTime}, #{createTime}, #{timeCount}, #{createTime},#{viewState} )
    </insert>


    <!-- 根据用户，知识 查询最新数据-->
    <select id="getInfo" parameterType="map" resultType="map">
        SELECT
        *
        FROM
        ${tableName}
        WHERE
        user_id = #{userId}
        AND kn_id =#{knId}
        ORDER BY
        create_time DESC
        limit 1
    </select>


    <!-- 根据id更新学习时间信息-->
    <update id="updateInfo" parameterType="map">
        UPDATE ${tableName}
        SET update_time = #{updateTime},
        end_time = #{endTime},
        time_count = #{timeCount}
        WHERE
        ID =#{id}
    </update>

    <!-- 统计今天的学习时长-->
    <select id="getDayInfo" parameterType="map" resultType="map">
        SELECT
        user_id,
        kn_id,
        SUM ( time_count )
        FROM
        ${tableName}
        WHERE
        to_char( create_time, 'YYYYMMDD' )= #{timeDay}
        GROUP BY
        user_id,
        kn_id
    </select>

</mapper>