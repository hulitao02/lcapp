<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloud.user.dao.AppUserDao">




	<!--	新增方法 -->
	<sql id="base_column_list">
		id,username,password,nickname,head_img_url,phone,sex,"level",status,type,
		create_time,update_time,department_id,position_id,rank_num,arm_services
	</sql>
	<select id="getAppUserListByMap" parameterType="map" resultType="com.cloud.model.user.AppUser">
		select
		<include refid="base_column_list"></include>
		from app_user t
		<include refid="where_eq" />
	</select>

	<sql id="where_eq">
		<where>
			<if test="username != null and username != ''">
				and t.username = #{username}
			</if>
			<if test="nickname != null and nickname != ''">
				<bind name="_nickname" value="'%' + nickname + '%'"/>
				and t.nickname like #{_nickname}
			</if>
			<if test="enabled != null and enabled != ''">
				and t.enabled = #{enabled}::boolean
			</if>
			<if test="type != null and type != ''">
				and t.type = #{type}
			</if>
		</where>
	</sql>


	<update id="update">
		update app_user
		<set>
			<if test="password != null and password != ''">
				password = #{password,jdbcType=VARCHAR},
			</if>
			<if test="nickname != null and nickname != ''">
				nickname = #{nickname,jdbcType=VARCHAR},
			</if>
			<if test="departmentId != null ">
				department_id = #{departmentId,jdbcType=INTEGER},
			</if>
			<if test="positionId != null" >
				position_id = #{positionId,jdbcType=INTEGER},
			</if>
			<if test="phone != null and phone != ''">
				phone = #{phone,jdbcType=VARCHAR},
			</if>
			<if test="headImgUrl != null and headImgUrl != ''">
				head_img_url = #{headImgUrl,jdbcType=VARCHAR},
			</if>
			<if test="rankNum != null and rankNum != ''">
				rank_num = #{rankNum,jdbcType=VARCHAR},
			</if>
			<if test="enabled != null">
				enabled = #{enabled,jdbcType=VARCHAR},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="sex != null">
				sex = #{sex,jdbcType=BIT},
			</if>
			<if test="level != null" >
				"level" = #{level,jdbcType=INTEGER},
			</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>

	<sql id="where">
		<where>
			<if test="username != null and username != ''">
				<bind name="_username" value="'%' + username + '%'"/>
				and t.username like #{_username}
			</if>
			<if test="nickname != null and nickname != ''">
				<bind name="_nickname" value="'%' + nickname + '%'"/>
				and t.nickname like #{_nickname}
			</if>
			<if test="enabled != null and enabled != ''">
				and t.enabled = #{enabled}::boolean
			</if>
			<if test="type != null and type != ''">
				and t.type = #{type}
			</if>
			<if test="departmentIdList != null ">
				and t.department_id in
				<foreach collection="departmentIdList" open="(" close=")" separator="," item="departmentId">
					#{departmentId}::integer
				</foreach>
			</if>
		</where>
	</sql>
	<select id="count" resultType="int">
		select count(*) from app_user t
		<include refid="where" />
	</select>

	<select id="findData" resultType="com.cloud.model.user.AppUser">
		select * from app_user t
		<include refid="where" />
		order by t.id desc
		limit #{length} OFFSET #{start}
	</select>

	<select id="getAppUserByRole" parameterType="string" resultType="com.cloud.model.user.AppUser">
		SELECT
		*
		FROM
		app_user
		WHERE
		ID IN (
		SELECT
		ru.userid
		FROM
		sys_role_user ru
		JOIN sys_role ro ON ro.ID = ru.roleid
		WHERE
		1 = 1
		AND ro.code = #{roleCode}
		)
		And status = 1
	</select>

	<select id="getUsers" parameterType="map" resultType="map">
		SELECT
		*
		FROM
		app_user
		WHERE
		1 = 1
		<if test="userName != null and userName != ''">
			AND username = #{userName}
		</if>
		<if test="rankNum != null and rankNum != ''">
			AND rank_num = #{rankNum}
		</if>
		<if test="deptId != null and deptId != ''">
			AND department_id = #{deptId}
		</if>
	</select>

	<insert id="saveInfo" parameterType="map">
		INSERT INTO app_user ( username, PASSWORD, phone, sex, create_time, department_id, TYPE, update_time,rank_num )
		VALUES
		( #{userName}, #{password}, #{phone}, #{sex}, #{createTime}, #{deptId}, 'BACKEND', #{updateTime},#{rankNum} )
	</insert>
</mapper>